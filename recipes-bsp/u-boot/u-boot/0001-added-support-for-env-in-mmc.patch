From 2023492b36ac832718790f586695448379d697d2 Mon Sep 17 00:00:00 2001
From: Pierre Helbing <pierre.helbing@tu-ilmenau.de>
Date: Fri, 18 Sep 2020 16:55:17 +0200
Subject: [PATCH] - added support for env in mmc

---
 configs/rpi_3_32b_defconfig | 6 +++++-
 include/config_goldi.h      | 7 +++++++
 scripts/Makefile.autoconf   | 3 ++-
 3 files changed, 14 insertions(+), 2 deletions(-)
 create mode 100644 include/config_goldi.h

diff --git a/configs/rpi_3_32b_defconfig b/configs/rpi_3_32b_defconfig
index a714f9ec49..05749a8ac0 100644
--- a/configs/rpi_3_32b_defconfig
+++ b/configs/rpi_3_32b_defconfig
@@ -20,7 +20,6 @@ CONFIG_CMD_USB=y
 CONFIG_CMD_FS_UUID=y
 CONFIG_OF_EMBED=y
 CONFIG_DEFAULT_DEVICE_TREE="bcm2837-rpi-3-b"
-CONFIG_ENV_FAT_DEVICE_AND_PART="0:1"
 CONFIG_SYS_RELOC_GD_ENV_ADDR=y
 CONFIG_ENV_VARS_UBOOT_RUNTIME_CONFIG=y
 CONFIG_DM_KEYBOARD=y
@@ -46,3 +45,8 @@ CONFIG_SYS_WHITE_ON_BLACK=y
 CONFIG_CONSOLE_SCROLL_LINES=10
 CONFIG_PHYS_TO_BUS=y
 CONFIG_OF_LIBFDT_OVERLAY=y
+CONFIG_ENV_IS_IN_FAT=n
+CONFIG_ENV_IS_IN_MMC=y
+CONFIG_ENV_OFFSET=0x800000
+CONFIG_ENV_OFFSET_REDUND=0x1000000
+CONFIG_SYS_REDUNDAND_ENVIRONMENT=y
diff --git a/include/config_goldi.h b/include/config_goldi.h
new file mode 100644
index 0000000000..fb755ce987
--- /dev/null
+++ b/include/config_goldi.h
@@ -0,0 +1,7 @@
+#ifndef HEADER_CONFIG_GOLDI.H
+
+#define HEADER_CONFIG_GOLDI.H
+#define CONFIG_SYS_MMC_ENV_DEV  0
+#define CONFIG_SYS_MMC_ENV_PART  0
+
+#endif
diff --git a/scripts/Makefile.autoconf b/scripts/Makefile.autoconf
index 00b8fb34aa..408f64d1a8 100644
--- a/scripts/Makefile.autoconf
+++ b/scripts/Makefile.autoconf
@@ -109,7 +109,8 @@ define filechk_config_h
 	echo \#include \<configs/$(CONFIG_SYS_CONFIG_NAME).h\>;		\
 	echo \#include \<asm/config.h\>;				\
 	echo \#include \<linux/kconfig.h\>;				\
-	echo \#include \<config_fallbacks.h\>;)
+	echo \#include \<config_fallbacks.h\>;				\
+	echo \#include \<config_goldi.h\>;)
 endef
 
 include/config.h: scripts/Makefile.autoconf create_symlink FORCE
